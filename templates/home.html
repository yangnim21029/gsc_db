{% extends "base.html" %}

{% block content %}
{% if authenticated %}
<!-- 已登入：顯示數據建置管理介面 -->
<div class="status success">
  ✅ 已成功連接 Google Search Console
  <a href="/auth/logout" class="btn btn-danger" style="float: right;">登出</a>
</div>

<h2>🚀 GSC Daily Database - 數據建置管理</h2>

<!-- 數據總覽 -->
<div class="stats">
  <div class="stat-card">
    <div class="stat-number">{{ summary.total_sites or 0 }}</div>
    <div class="stat-label">管理站點</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ summary.total_keywords or 0 }}</div>
    <div class="stat-label">關鍵字數量</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ summary.latest_date or '無' }}</div>
    <div class="stat-label">最新數據日期</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="total-records">載入中...</div>
    <div class="stat-label">總記錄數</div>
  </div>
</div>

<!-- 快速操作按鈕 -->
<div style="margin: 30px 0;">
  <h3>📊 數據建置操作</h3>
  <div class="action-buttons">
    <button class="btn" onclick="loadBuildStatus()">🔍 檢查建置狀態</button>
    <button class="btn" onclick="buildRecentData()">⚡ 建置最近數據</button>
    <button class="btn" onclick="showSiteBuildPanel()">🎯 單站點建置</button>
    <button class="btn" onclick="showProgressPanel()">📋 查看進度</button>
    <button class="btn" onclick="resumeInterruptedTasks()">🔄 恢復中斷任務</button>
    <a href="/data-builder/status" class="btn">📈 查看詳細狀態</a>
    <a href="/sites/" class="btn">🏢 管理站點</a>
  </div>
</div>

<!-- 單站點建置面板 -->
<div id="site-build-panel"
  style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #28a745;">
  <h3 style="color: #155724; margin-bottom: 15px;">🎯 單站點數據建置</h3>

  <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
    <div style="color: #155724; font-weight: bold;">選擇站點和日期範圍進行建置</div>
    <button onclick="hideSiteBuildPanel()" class="btn btn-small">❌ 關閉面板</button>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <!-- 站點選擇 -->
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">選擇站點:</label>
      <select id="site-select" style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
        <option value="">載入中...</option>
      </select>
    </div>

    <!-- 建置選項 -->
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">建置模式:</label>
      <select id="build-mode" style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
        <option value="incremental">增量建置 (只建置缺失日期)</option>
        <option value="force">強制重建 (重建所有日期)</option>
        <option value="recent">最近數據 (最近7天)</option>
      </select>
    </div>
  </div>

  <div id="date-range-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">開始日期:</label>
      <input type="date" id="start-date"
        style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">結束日期:</label>
      <input type="date" id="end-date"
        style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
    </div>
  </div>

  <div style="text-align: center;">
    <button onclick="startSiteBuild()" class="btn"
      style="background: #28a745; color: white; padding: 12px 30px; font-size: 16px;">
      🚀 開始建置
    </button>
  </div>

  <!-- 建置狀態顯示 -->
  <div id="site-build-status"
    style="display: none; margin-top: 20px; padding: 15px; background: white; border-radius: 5px; border: 1px solid #28a745;">
    <h4 style="color: #155724; margin-bottom: 10px;">建置狀態</h4>
    <div id="site-build-progress"></div>
  </div>
</div>

<!-- 進度追蹤面板 -->
<div id="progress-panel"
  style="display: none; margin-top: 20px; padding: 20px; background: #f0f8ff; border-radius: 10px; border: 2px solid #4a90e2;">
  <h3 style="color: #2c5aa0; margin-bottom: 15px;">📋 建置進度追蹤</h3>

  <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
    <div>
      <button onclick="loadRunningTasks()" class="btn btn-small">🔄 刷新進度</button>
      <button onclick="cancelAllTasks()" class="btn btn-small" style="background: #dc3545; color: white;">🛑
        取消所有任務</button>
    </div>
    <button onclick="hideProgressPanel()" class="btn btn-small">❌ 關閉面板</button>
  </div>

  <!-- 運行中的任務 -->
  <div id="running-tasks-section">
    <h4 style="color: #2c5aa0;">🏃‍♂️ 運行中的任務</h4>
    <div id="running-tasks-content">
      <div style="color: #666; font-style: italic;">載入中...</div>
    </div>
  </div>

  <!-- 最近的任務 -->
  <div id="recent-tasks-section" style="margin-top: 20px;">
    <h4 style="color: #2c5aa0;">📝 最近的任務</h4>
    <div id="recent-tasks-content">
      <div style="color: #666; font-style: italic;">載入中...</div>
    </div>
  </div>
</div>

<!-- 結果顯示區域 -->
<div id="result-section"
  style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
  <h3 id="result-title">結果</h3>
  <div id="result-content"></div>
</div>

<!-- 即時 Log 顯示區域 -->
<div id="log-section"
  style="display: none; margin-top: 20px; padding: 20px; background: #1e1e1e; color: #00ff00; border-radius: 10px; font-family: 'Courier New', monospace;">
  <h3 style="color: #fff; margin-bottom: 15px;">📄 即時建置 Log</h3>
  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
    <button onclick="toggleLogMonitoring()" id="log-toggle-btn" class="btn btn-small">🟢 開始監控</button>
    <button onclick="clearLogs()" class="btn btn-small">🗑️ 清除 Log</button>
  </div>
  <div id="log-content"
    style="height: 300px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: #000; font-size: 12px; line-height: 1.4;">
    <div style="color: #888;">Log 監控已準備就緒，點擊開始監控按鈕...</div>
  </div>
</div>

<!-- 載入指示器 -->
<div id="loading" style="display: none; text-align: center; padding: 20px;">
  <h3>⏳ 處理中...</h3>
  <p>正在執行數據建置，請稍候...</p>
</div>

<!-- 站點列表 -->
<h3>站點管理</h3>
{% if sites %}
<table class="sites-table">
  <thead>
    <tr>
      <th>站點名稱</th>
      <th>關鍵字數</th>
      <th>最新數據</th>
      <th>狀態</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for site in sites %}
    <tr>
      <td>{{ site.name }}</td>
      <td>{{ site.keyword_count or 0 }}</td>
      <td>{{ site.latest_data_date or '無數據' }}</td>
      <td>
        {% if site.keyword_count > 0 %}
        <span class="status success">有數據</span>
        {% else %}
        <span class="status error">無數據</span>
        {% endif %}
      </td>
      <td>
        <a href="/data-builder/missing-dates/{{ site.id }}?start_date=2025-05-20&end_date=2025-06-10"
          class="btn btn-small">檢查缺失</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>尚未導入任何站點</p>
{% endif %}

<div style="margin-top: 30px;">
  <h3>🔗 API 端點</h3>
  <ul>
    <li><a href="/data-builder/status">/data-builder/status</a> - 數據建置狀態</li>
    <li><a href="/data-builder/coverage">/data-builder/coverage</a> - 數據覆蓋分析</li>
    <li><a href="/sites/">/sites/</a> - 站點管理</li>
    <li><a href="/analytics/">/analytics/</a> - 數據分析</li>
  </ul>
</div>

{% else %}
<!-- 未登入：顯示登入頁面 -->
<div class="status warning">
  請先登入 Google Search Console 以開始使用
</div>

<div style="text-align: center; margin: 40px 0;">
  <h2>開始使用 GSC 數據建置系統</h2>
  <p>連接您的 Google Search Console 帳戶，開始建置和分析網站 SEO 數據</p>

  <a href="#" onclick="startLogin()" class="btn" style="font-size: 16px; padding: 15px 30px;">
    🔐 使用 Google 帳戶登入
  </a>
</div>

<div style="margin-top: 40px;">
  <h3>功能介紹</h3>
  <ul style="line-height: 1.8;">
    <li>📊 大量數據建置和同步</li>
    <li>📈 關鍵字和頁面數據分析</li>
    <li>🎯 智能缺失數據檢測</li>
    <li>📱 支援多個網站管理</li>
    <li>🔍 增量建置節省時間</li>
  </ul>
</div>
{% endif %}

<script>
  // 簡化的 JavaScript 函數
  function loadBuildStatus() {
    showLoading();
    fetch('/data-builder/status')
      .then(response => response.json())
      .then(data => {
        document.getElementById('total-records').textContent =
          (data.overall_status?.total_records || 0).toLocaleString();
        showResult('📊 數據建置狀態', '總記錄數: ' + (data.overall_status?.total_records || 0).toLocaleString());
      })
      .catch(error => {
        showResult('❌ 錯誤', '載入失敗: ' + error.message);
      })
      .finally(() => hideLoading());
  }

  function buildRecentData() {
    showLoading();
    startLogMonitoring(); // 開始監控 log

    fetch('/data-builder/build/recent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ days_back: 7 })
    })
      .then(response => response.json())
      .then(data => {
        showResult('⚡ 最近數據建置完成', '成功建置 ' + (data.summary?.total_records || 0) + ' 筆記錄');
      })
      .catch(error => {
        showResult('❌ 錯誤', '建置失敗: ' + error.message);
      })
      .finally(() => {
        hideLoading();
        setTimeout(() => stopLogMonitoring(), 5000); // 5秒後停止監控
      });
  }

  function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result-section').style.display = 'none';
  }

  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
  }

  function showResult(title, content) {
    document.getElementById('result-title').textContent = title;
    document.getElementById('result-content').innerHTML = content;
    document.getElementById('result-section').style.display = 'block';
  }

  function startLogin() {
    fetch('/auth/login')
      .then(response => response.json())
      .then(data => {
        if (data.auth_url) {
          window.location.href = data.auth_url;
        } else {
          alert('登入失敗：' + (data.error || '未知錯誤'));
        }
      })
      .catch(error => {
        alert('登入失敗，請檢查網路連線');
      });
  }

  // Log 監控相關變數
  let logMonitoringInterval = null;
  let isLogMonitoring = false;
  let lastLogTimestamp = null;

  function toggleLogMonitoring() {
    if (isLogMonitoring) {
      stopLogMonitoring();
    } else {
      startLogMonitoring();
    }
  }

  function startLogMonitoring() {
    if (isLogMonitoring) return;

    isLogMonitoring = true;
    document.getElementById('log-section').style.display = 'block';
    document.getElementById('log-toggle-btn').textContent = '🔴 停止監控';
    document.getElementById('log-toggle-btn').style.background = '#dc3545';

    // 每2秒檢查一次新的 log
    logMonitoringInterval = setInterval(fetchRecentLogs, 2000);

    // 立即執行一次
    fetchRecentLogs();
  }

  function stopLogMonitoring() {
    if (!isLogMonitoring) return;

    isLogMonitoring = false;
    document.getElementById('log-toggle-btn').textContent = '🟢 開始監控';
    document.getElementById('log-toggle-btn').style.background = '';

    if (logMonitoringInterval) {
      clearInterval(logMonitoringInterval);
      logMonitoringInterval = null;
    }
  }

  function fetchRecentLogs() {
    const params = lastLogTimestamp ? `?since=${lastLogTimestamp}` : '?lines=20';

    fetch(`/api/logs${params}`)
      .then(response => response.json())
      .then(data => {
        if (data.logs && data.logs.length > 0) {
          appendLogs(data.logs);
          lastLogTimestamp = data.latest_timestamp;
        }
      })
      .catch(error => {
        console.error('Failed to fetch logs:', error);
      });
  }

  function appendLogs(logs) {
    const logContent = document.getElementById('log-content');

    logs.forEach(log => {
      const logLine = document.createElement('div');
      logLine.style.marginBottom = '2px';

      // 根據 log 類型設定顏色
      if (log.includes('ERROR')) {
        logLine.style.color = '#ff6b6b';
      } else if (log.includes('WARNING')) {
        logLine.style.color = '#feca57';
      } else if (log.includes('data_builder') || log.includes('Building')) {
        logLine.style.color = '#48cae4';
      } else if (log.includes('gsc_client') || log.includes('Syncing')) {
        logLine.style.color = '#06ffa5';
      } else {
        logLine.style.color = '#00ff00';
      }

      logLine.textContent = log;
      logContent.appendChild(logLine);
    });

    // 自動滾動到底部
    logContent.scrollTop = logContent.scrollHeight;
  }

  function clearLogs() {
    document.getElementById('log-content').innerHTML = '<div style="color: #888;">Log 已清除...</div>';
    lastLogTimestamp = null;
  }

  // 進度追蹤相關函數
  function showProgressPanel() {
    document.getElementById('progress-panel').style.display = 'block';
    loadRunningTasks();
    loadRecentTasks();
  }

  function hideProgressPanel() {
    document.getElementById('progress-panel').style.display = 'none';
  }

  function loadRunningTasks() {
    fetch('/data-builder/progress/running')
      .then(response => response.json())
      .then(data => {
        const content = document.getElementById('running-tasks-content');

        if (data.running_tasks && data.running_tasks.length > 0) {
          let html = '';
          data.running_tasks.forEach(task => {
            const progress = task.progress_percentage || 0;
            const statusColor = task.status === 'running' ? '#28a745' : '#dc3545';

            html += `
              <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${task.site_name || 'Unknown Site'}</strong> 
                    <span style="color: ${statusColor};">(${task.status})</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 12px; color: #666;">
                      ${task.current_date || 'N/A'} | ${task.completed_dates || 0}/${task.total_dates || 0} 天
                    </div>
                    <button onclick="cancelTask('${task.task_id}')" 
                            style="background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;"
                            title="取消此任務">🛑</button>
                  </div>
                </div>
                <div style="margin: 5px 0;">
                  <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: #007bff; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                  </div>
                  <div style="font-size: 12px; color: #666; margin-top: 2px;">
                    ${progress.toFixed(1)}% 完成 | ${task.total_records || 0} 筆記錄
                  </div>
                </div>
                <div style="font-size: 11px; color: #999;">
                  任務 ID: ${task.task_id} | 類型: ${task.task_type}
                </div>
              </div>
            `;
          });
          content.innerHTML = html;
        } else {
          content.innerHTML = '<div style="color: #666; font-style: italic;">目前沒有運行中的任務</div>';
        }
      })
      .catch(error => {
        document.getElementById('running-tasks-content').innerHTML =
          '<div style="color: #dc3545;">載入失敗: ' + error.message + '</div>';
      });
  }

  function loadRecentTasks() {
    fetch('/data-builder/progress/recent?limit=5')
      .then(response => response.json())
      .then(data => {
        const content = document.getElementById('recent-tasks-content');

        if (data.recent_tasks && data.recent_tasks.length > 0) {
          let html = '';
          data.recent_tasks.forEach(task => {
            const statusColor = task.status === 'completed' ? '#28a745' :
              task.status === 'failed' ? '#dc3545' : '#ffc107';
            const statusIcon = task.status === 'completed' ? '✅' :
              task.status === 'failed' ? '❌' : '⏳';

            html += `
              <div style="border: 1px solid #ddd; padding: 8px; margin: 3px 0; border-radius: 5px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span>${statusIcon}</span>
                    <strong>${task.site_name || 'Unknown Site'}</strong>
                    <span style="color: ${statusColor};">(${task.status})</span>
                  </div>
                  <div style="font-size: 11px; color: #666;">
                    ${task.completed_at || task.updated_at || 'N/A'}
                  </div>
                </div>
                <div style="font-size: 12px; color: #666;">
                  ${task.completed_dates || 0}/${task.total_dates || 0} 天 | 
                  ${task.total_records || 0} 筆記錄
                  ${task.error_message ? ' | 錯誤: ' + task.error_message : ''}
                </div>
              </div>
            `;
          });
          content.innerHTML = html;
        } else {
          content.innerHTML = '<div style="color: #666; font-style: italic;">沒有最近的任務記錄</div>';
        }
      })
      .catch(error => {
        document.getElementById('recent-tasks-content').innerHTML =
          '<div style="color: #dc3545;">載入失敗: ' + error.message + '</div>';
      });
  }

  function resumeInterruptedTasks() {
    if (!confirm('確定要恢復中斷的任務嗎？這將標記中斷的任務並可能創建新的恢復任務。')) {
      return;
    }

    fetch('/data-builder/progress/resume', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
      .then(response => response.json())
      .then(data => {
        showResult('🔄 任務恢復', data.message);
        if (document.getElementById('progress-panel').style.display !== 'none') {
          loadRunningTasks();
          loadRecentTasks();
        }
      })
      .catch(error => {
        showResult('❌ 錯誤', '恢復任務失敗: ' + error.message);
      });
  }

  function cancelTask(taskId) {
    if (!confirm(`確定要取消任務 ${taskId} 嗎？此操作無法撤銷。`)) {
      return;
    }

    fetch(`/data-builder/progress/cancel/${taskId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: 'User cancelled via web interface' })
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showResult('❌ 錯誤', data.error);
        } else {
          showResult('🛑 任務已取消', data.message);
          // 刷新進度顯示
          if (document.getElementById('progress-panel').style.display !== 'none') {
            loadRunningTasks();
            loadRecentTasks();
          }
        }
      })
      .catch(error => {
        showResult('❌ 錯誤', '取消任務失敗: ' + error.message);
      });
  }

  function cancelAllTasks() {
    if (!confirm('確定要取消所有運行中的任務嗎？此操作無法撤銷。')) {
      return;
    }

    fetch('/data-builder/progress/cancel-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: 'User cancelled all tasks via web interface' })
    })
      .then(response => response.json())
      .then(data => {
        showResult('🛑 批量取消完成', data.message);
        // 刷新進度顯示
        if (document.getElementById('progress-panel').style.display !== 'none') {
          loadRunningTasks();
          loadRecentTasks();
        }
      })
      .catch(error => {
        showResult('❌ 錯誤', '批量取消失敗: ' + error.message);
      });
  }

  // 單站點建置相關函數
  function showSiteBuildPanel() {
    document.getElementById('site-build-panel').style.display = 'block';
    loadSiteOptions();
    setDefaultDates();
  }

  function hideSiteBuildPanel() {
    document.getElementById('site-build-panel').style.display = 'none';
    document.getElementById('site-build-status').style.display = 'none';
  }

  function loadSiteOptions() {
    // 從現有的站點數據載入選項
    const siteSelect = document.getElementById('site-select');
    siteSelect.innerHTML = '<option value="">請選擇站點...</option>';

    // 從站點表格中獲取站點資訊
    const siteRows = document.querySelectorAll('.sites-table tbody tr');
    siteRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length >= 4) {
        const siteName = cells[0].textContent.trim();
        const keywordCount = cells[1].textContent.trim();

        // 從操作列的連結中提取 site_id
        const actionLink = cells[4].querySelector('a[href*="missing-dates"]');
        if (actionLink) {
          const href = actionLink.getAttribute('href');
          const siteIdMatch = href.match(/missing-dates\/(\d+)/);
          if (siteIdMatch) {
            const siteId = siteIdMatch[1];
            const option = document.createElement('option');
            option.value = siteId;
            option.textContent = `${siteName} (${keywordCount} 關鍵字)`;
            siteSelect.appendChild(option);
          }
        }
      }
    });
  }

  function setDefaultDates() {
    const today = new Date();
    const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    const threeDaysAgo = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000); // GSC 數據延遲

    document.getElementById('start-date').value = oneWeekAgo.toISOString().split('T')[0];
    document.getElementById('end-date').value = threeDaysAgo.toISOString().split('T')[0];
  }

  function startSiteBuild() {
    const siteId = document.getElementById('site-select').value;
    const buildMode = document.getElementById('build-mode').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!siteId) {
      alert('請選擇一個站點');
      return;
    }

    let buildData = {};
    let endpoint = '';

    if (buildMode === 'recent') {
      // 最近數據建置
      endpoint = '/data-builder/build/recent';
      buildData = {
        site_ids: [parseInt(siteId)],
        days_back: 7
      };
    } else {
      // 日期範圍建置
      if (!startDate || !endDate) {
        alert('請選擇開始和結束日期');
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        alert('開始日期不能晚於結束日期');
        return;
      }

      endpoint = `/data-builder/build/site/${siteId}`;
      buildData = {
        start_date: startDate,
        end_date: endDate,
        force_rebuild: buildMode === 'force'
      };
    }

    // 顯示建置狀態
    document.getElementById('site-build-status').style.display = 'block';
    document.getElementById('site-build-progress').innerHTML = `
      <div style="color: #155724;">
        <div>🚀 正在啟動建置...</div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          站點: ${document.getElementById('site-select').selectedOptions[0].text}<br>
          模式: ${buildMode === 'incremental' ? '增量建置' : buildMode === 'force' ? '強制重建' : '最近數據'}<br>
          ${buildMode !== 'recent' ? `日期範圍: ${startDate} 到 ${endDate}` : '日期範圍: 最近7天'}
        </div>
      </div>
    `;

    // 開始即時 log 監控
    startLogMonitoring();

    // 發送建置請求
    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(buildData)
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          document.getElementById('site-build-progress').innerHTML = `
            <div style="color: #dc3545;">
              ❌ 建置失敗: ${data.error}
            </div>
          `;
        } else {
          const taskId = data.task_id;
          document.getElementById('site-build-progress').innerHTML = `
            <div style="color: #28a745;">
              ✅ 建置已完成！<br>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ${data.message}<br>
                ${data.summary ? `總記錄數: ${data.summary.total_records || 0}` : ''}
                ${taskId ? `<br>任務 ID: ${taskId}` : ''}
              </div>
            </div>
          `;

          // 刷新狀態
          loadBuildStatus();
          if (document.getElementById('progress-panel').style.display !== 'none') {
            loadRunningTasks();
            loadRecentTasks();
          }
        }
      })
      .catch(error => {
        document.getElementById('site-build-progress').innerHTML = `
          <div style="color: #dc3545;">
            ❌ 建置失敗: ${error.message}
          </div>
        `;
      })
      .finally(() => {
        setTimeout(() => stopLogMonitoring(), 3000); // 3秒後停止監控
      });
  }

  // 頁面載入後自動載入狀態
  document.addEventListener('DOMContentLoaded', function () {
    // 只有在已登入狀態才載入
    if (document.querySelector('.status.success')) {
      loadBuildStatus();
    }
  });
</script>
{% endblock %}