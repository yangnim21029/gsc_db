# API Contract Definitions
# This file defines the expected input/output contracts for all API endpoints
# Used by test_api_contract.py to ensure API stability

endpoints:
  - name: "Root Endpoint"
    path: "/"
    method: "GET"
    response:
      status_code: 200
      body:
        service: "GSC Database Manager API"
        version: "2.0.0"
        docs: "/schema/swagger"
        openapi: "/schema"

  - name: "Health Check"
    path: "/api/v1/health"
    method: "GET"
    response:
      status_code: 200
      body:
        status: "healthy"
        database: boolean
        timestamp: string (ISO 8601)
        version: string

  - name: "List Sites"
    path: "/api/v1/sites"
    method: "GET"
    response:
      status_code: 200
      body:
        type: array
        items:
          id: integer
          domain: string
          name: string
          category: string or null
          is_active: boolean
          created_at: string (ISO 8601)
          updated_at: string (ISO 8601)

  - name: "Page-Keyword Performance"
    path: "/api/v1/page-keyword-performance"
    method: "GET"
    parameters:
      site_id: 
        type: integer
        required: true
      days: 
        type: integer
        optional: true
        default: 30
      start_date: 
        type: string
        format: ISO date
        optional: true
      end_date: 
        type: string
        format: ISO date
        optional: true
      url_filter: 
        type: string
        optional: true
      limit: 
        type: integer
        optional: true
        default: 1000
    response:
      status_code: 200
      body:
        data: 
          type: array
          items:
            url: string
            total_clicks: integer
            total_impressions: integer
            avg_ctr: float (4 decimal places)
            avg_position: float (2 decimal places)
            keywords: array of string
            keyword_count: integer
        total_pages: integer
        total_keywords: integer
        generated_at: string (ISO 8601)

  - name: "Page-Keyword Performance CSV Export"
    path: "/api/v1/page-keyword-performance/csv"
    method: "GET"
    parameters:
      site_id:
        type: integer
        required: true
      days:
        type: integer
        optional: true
        default: 30
      start_date:
        type: string
        format: ISO date
        optional: true
      end_date:
        type: string
        format: ISO date
        optional: true
      url_filter:
        type: string
        optional: true
      max_results:
        type: integer
        optional: true
    response:
      status_code: 200
      headers:
        content-type: "text/csv; charset=utf-8"
        content-disposition: 'attachment; filename="gsc_performance_*.csv"'
      body: |
        CSV format with header:
        url,total_clicks,total_impressions,avg_ctr,avg_position,keywords,keyword_count

        Data rows with:
        - Quoted strings for url and keywords
        - Keywords separated by pipe (|) character
        - Numeric values without quotes
        - Float values with appropriate precision

  - name: "Database Diagnostics"
    path: "/api/v1/diagnostics/database"
    method: "GET"
    response:
      status_code: 200
      body:
        status: "ok" or "warning" or "error"
        details:
          tables: object with table names as keys
          indexes: array of index info
          total_size_mb: float
          wal_size_mb: float
          page_size: integer
          journal_mode: string

error_responses:
  - status_code: 400
    description: "Bad Request - Invalid parameters"
    body:
      detail: string or array of validation errors

  - status_code: 404
    description: "Not Found - Resource doesn't exist"
    body:
      detail: string

  - status_code: 405
    description: "Method Not Allowed"
    body:
      detail: string

  - status_code: 500
    description: "Internal Server Error"
    body:
      detail: string

data_format_rules:
  dates:
    - All dates in ISO 8601 format (YYYY-MM-DD)
    - Timestamps include timezone (Z for UTC)

  numbers:
    - CTR values: 4 decimal places (0.1234)
    - Position values: 2 decimal places (10.50)
    - Counts: integers

  csv:
    - Header row always present
    - String values quoted
    - Keywords separated by pipe character (|)
    - UTF-8 encoding
    - Line endings: \n

backwards_compatibility:
  - New optional parameters can be added
  - Existing parameter names cannot change
  - Response field names cannot change
  - New fields can be added to responses
  - Field types must remain consistent
  - Error response format must remain consistent
