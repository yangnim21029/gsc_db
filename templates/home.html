{% extends "base.html" %}

{% block content %}
{% if authenticated %}
<!-- å·²ç™»å…¥ï¼šé¡¯ç¤ºæ•¸æ“šå»ºç½®ç®¡ç†ä»‹é¢ -->
<div class="status success">
  âœ… å·²æˆåŠŸé€£æ¥ Google Search Console
  <a href="/auth/logout" class="btn btn-danger" style="float: right;">ç™»å‡º</a>
</div>

<h2>ğŸš€ GSC Daily Database - æ•¸æ“šå»ºç½®ç®¡ç†</h2>

<!-- æ•¸æ“šç¸½è¦½ -->
<div class="stats">
  <div class="stat-card">
    <div class="stat-number">{{ summary.total_sites or 0 }}</div>
    <div class="stat-label">ç®¡ç†ç«™é»</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ summary.total_keywords or 0 }}</div>
    <div class="stat-label">é—œéµå­—æ•¸é‡</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ summary.latest_date or 'ç„¡' }}</div>
    <div class="stat-label">æœ€æ–°æ•¸æ“šæ—¥æœŸ</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="total-records">è¼‰å…¥ä¸­...</div>
    <div class="stat-label">ç¸½è¨˜éŒ„æ•¸</div>
  </div>
</div>

<!-- å¿«é€Ÿæ“ä½œæŒ‰éˆ• -->
<div style="margin: 30px 0;">
  <h3>ğŸ“Š æ•¸æ“šå»ºç½®æ“ä½œ</h3>
  <div class="action-buttons">
    <button class="btn" onclick="loadBuildStatus()">ğŸ” æª¢æŸ¥å»ºç½®ç‹€æ…‹</button>
    <button class="btn" onclick="buildRecentData()">âš¡ å»ºç½®æœ€è¿‘æ•¸æ“š</button>
    <button class="btn" onclick="showSiteBuildPanel()">ğŸ¯ å–®ç«™é»å»ºç½®</button>
    <button class="btn" onclick="showProgressPanel()">ğŸ“‹ æŸ¥çœ‹é€²åº¦</button>
    <button class="btn" onclick="resumeInterruptedTasks()">ğŸ”„ æ¢å¾©ä¸­æ–·ä»»å‹™</button>
    <a href="/data-builder/status" class="btn">ğŸ“ˆ æŸ¥çœ‹è©³ç´°ç‹€æ…‹</a>
    <a href="/sites/" class="btn">ğŸ¢ ç®¡ç†ç«™é»</a>
  </div>
</div>

<!-- å–®ç«™é»å»ºç½®é¢æ¿ -->
<div id="site-build-panel"
  style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #28a745;">
  <h3 style="color: #155724; margin-bottom: 15px;">ğŸ¯ å–®ç«™é»æ•¸æ“šå»ºç½®</h3>

  <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
    <div style="color: #155724; font-weight: bold;">é¸æ“‡ç«™é»å’Œæ—¥æœŸç¯„åœé€²è¡Œå»ºç½®</div>
    <button onclick="hideSiteBuildPanel()" class="btn btn-small">âŒ é—œé–‰é¢æ¿</button>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <!-- ç«™é»é¸æ“‡ -->
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">é¸æ“‡ç«™é»:</label>
      <select id="site-select" style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
        <option value="">è¼‰å…¥ä¸­...</option>
      </select>
    </div>

    <!-- å»ºç½®é¸é … -->
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">å»ºç½®æ¨¡å¼:</label>
      <select id="build-mode" style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
        <option value="incremental">å¢é‡å»ºç½® (åªå»ºç½®ç¼ºå¤±æ—¥æœŸ)</option>
        <option value="force">å¼·åˆ¶é‡å»º (é‡å»ºæ‰€æœ‰æ—¥æœŸ)</option>
        <option value="recent">æœ€è¿‘æ•¸æ“š (æœ€è¿‘7å¤©)</option>
      </select>
    </div>
  </div>

  <div id="date-range-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">é–‹å§‹æ—¥æœŸ:</label>
      <input type="date" id="start-date"
        style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #155724;">çµæŸæ—¥æœŸ:</label>
      <input type="date" id="end-date"
        style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 5px;">
    </div>
  </div>

  <div style="text-align: center;">
    <button onclick="startSiteBuild()" class="btn"
      style="background: #28a745; color: white; padding: 12px 30px; font-size: 16px;">
      ğŸš€ é–‹å§‹å»ºç½®
    </button>
  </div>

  <!-- å»ºç½®ç‹€æ…‹é¡¯ç¤º -->
  <div id="site-build-status"
    style="display: none; margin-top: 20px; padding: 15px; background: white; border-radius: 5px; border: 1px solid #28a745;">
    <h4 style="color: #155724; margin-bottom: 10px;">å»ºç½®ç‹€æ…‹</h4>
    <div id="site-build-progress"></div>
  </div>
</div>

<!-- é€²åº¦è¿½è¹¤é¢æ¿ -->
<div id="progress-panel"
  style="display: none; margin-top: 20px; padding: 20px; background: #f0f8ff; border-radius: 10px; border: 2px solid #4a90e2;">
  <h3 style="color: #2c5aa0; margin-bottom: 15px;">ğŸ“‹ å»ºç½®é€²åº¦è¿½è¹¤</h3>

  <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
    <div>
      <button onclick="loadRunningTasks()" class="btn btn-small">ğŸ”„ åˆ·æ–°é€²åº¦</button>
      <button onclick="cancelAllTasks()" class="btn btn-small" style="background: #dc3545; color: white;">ğŸ›‘
        å–æ¶ˆæ‰€æœ‰ä»»å‹™</button>
    </div>
    <button onclick="hideProgressPanel()" class="btn btn-small">âŒ é—œé–‰é¢æ¿</button>
  </div>

  <!-- é‹è¡Œä¸­çš„ä»»å‹™ -->
  <div id="running-tasks-section">
    <h4 style="color: #2c5aa0;">ğŸƒâ€â™‚ï¸ é‹è¡Œä¸­çš„ä»»å‹™</h4>
    <div id="running-tasks-content">
      <div style="color: #666; font-style: italic;">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <!-- æœ€è¿‘çš„ä»»å‹™ -->
  <div id="recent-tasks-section" style="margin-top: 20px;">
    <h4 style="color: #2c5aa0;">ğŸ“ æœ€è¿‘çš„ä»»å‹™</h4>
    <div id="recent-tasks-content">
      <div style="color: #666; font-style: italic;">è¼‰å…¥ä¸­...</div>
    </div>
  </div>
</div>

<!-- çµæœé¡¯ç¤ºå€åŸŸ -->
<div id="result-section"
  style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
  <h3 id="result-title">çµæœ</h3>
  <div id="result-content"></div>
</div>

<!-- å³æ™‚ Log é¡¯ç¤ºå€åŸŸ -->
<div id="log-section"
  style="display: none; margin-top: 20px; padding: 20px; background: #1e1e1e; color: #00ff00; border-radius: 10px; font-family: 'Courier New', monospace;">
  <h3 style="color: #fff; margin-bottom: 15px;">ğŸ“„ å³æ™‚å»ºç½® Log</h3>
  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
    <button onclick="toggleLogMonitoring()" id="log-toggle-btn" class="btn btn-small">ğŸŸ¢ é–‹å§‹ç›£æ§</button>
    <button onclick="clearLogs()" class="btn btn-small">ğŸ—‘ï¸ æ¸…é™¤ Log</button>
  </div>
  <div id="log-content"
    style="height: 300px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: #000; font-size: 12px; line-height: 1.4;">
    <div style="color: #888;">Log ç›£æ§å·²æº–å‚™å°±ç·’ï¼Œé»æ“Šé–‹å§‹ç›£æ§æŒ‰éˆ•...</div>
  </div>
</div>

<!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
<div id="loading" style="display: none; text-align: center; padding: 20px;">
  <h3>â³ è™•ç†ä¸­...</h3>
  <p>æ­£åœ¨åŸ·è¡Œæ•¸æ“šå»ºç½®ï¼Œè«‹ç¨å€™...</p>
</div>

<!-- ç«™é»åˆ—è¡¨ -->
<h3>ç«™é»ç®¡ç†</h3>
{% if sites %}
<table class="sites-table">
  <thead>
    <tr>
      <th>ç«™é»åç¨±</th>
      <th>é—œéµå­—æ•¸</th>
      <th>æœ€æ–°æ•¸æ“š</th>
      <th>ç‹€æ…‹</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    {% for site in sites %}
    <tr>
      <td>{{ site.name }}</td>
      <td>{{ site.keyword_count or 0 }}</td>
      <td>{{ site.latest_data_date or 'ç„¡æ•¸æ“š' }}</td>
      <td>
        {% if site.keyword_count > 0 %}
        <span class="status success">æœ‰æ•¸æ“š</span>
        {% else %}
        <span class="status error">ç„¡æ•¸æ“š</span>
        {% endif %}
      </td>
      <td>
        <a href="/data-builder/missing-dates/{{ site.id }}?start_date=2025-05-20&end_date=2025-06-10"
          class="btn btn-small">æª¢æŸ¥ç¼ºå¤±</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>å°šæœªå°å…¥ä»»ä½•ç«™é»</p>
{% endif %}

<div style="margin-top: 30px;">
  <h3>ğŸ”— API ç«¯é»</h3>
  <ul>
    <li><a href="/data-builder/status">/data-builder/status</a> - æ•¸æ“šå»ºç½®ç‹€æ…‹</li>
    <li><a href="/data-builder/coverage">/data-builder/coverage</a> - æ•¸æ“šè¦†è“‹åˆ†æ</li>
    <li><a href="/sites/">/sites/</a> - ç«™é»ç®¡ç†</li>
    <li><a href="/analytics/">/analytics/</a> - æ•¸æ“šåˆ†æ</li>
  </ul>
</div>

{% else %}
<!-- æœªç™»å…¥ï¼šé¡¯ç¤ºç™»å…¥é é¢ -->
<div class="status warning">
  è«‹å…ˆç™»å…¥ Google Search Console ä»¥é–‹å§‹ä½¿ç”¨
</div>

<div style="text-align: center; margin: 40px 0;">
  <h2>é–‹å§‹ä½¿ç”¨ GSC æ•¸æ“šå»ºç½®ç³»çµ±</h2>
  <p>é€£æ¥æ‚¨çš„ Google Search Console å¸³æˆ¶ï¼Œé–‹å§‹å»ºç½®å’Œåˆ†æç¶²ç«™ SEO æ•¸æ“š</p>

  <a href="#" onclick="startLogin()" class="btn" style="font-size: 16px; padding: 15px 30px;">
    ğŸ” ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥
  </a>
</div>

<div style="margin-top: 40px;">
  <h3>åŠŸèƒ½ä»‹ç´¹</h3>
  <ul style="line-height: 1.8;">
    <li>ğŸ“Š å¤§é‡æ•¸æ“šå»ºç½®å’ŒåŒæ­¥</li>
    <li>ğŸ“ˆ é—œéµå­—å’Œé é¢æ•¸æ“šåˆ†æ</li>
    <li>ğŸ¯ æ™ºèƒ½ç¼ºå¤±æ•¸æ“šæª¢æ¸¬</li>
    <li>ğŸ“± æ”¯æ´å¤šå€‹ç¶²ç«™ç®¡ç†</li>
    <li>ğŸ” å¢é‡å»ºç½®ç¯€çœæ™‚é–“</li>
  </ul>
</div>
{% endif %}

<script>
  // ç°¡åŒ–çš„ JavaScript å‡½æ•¸
  function loadBuildStatus() {
    showLoading();
    fetch('/data-builder/status')
      .then(response => response.json())
      .then(data => {
        document.getElementById('total-records').textContent =
          (data.overall_status?.total_records || 0).toLocaleString();
        showResult('ğŸ“Š æ•¸æ“šå»ºç½®ç‹€æ…‹', 'ç¸½è¨˜éŒ„æ•¸: ' + (data.overall_status?.total_records || 0).toLocaleString());
      })
      .catch(error => {
        showResult('âŒ éŒ¯èª¤', 'è¼‰å…¥å¤±æ•—: ' + error.message);
      })
      .finally(() => hideLoading());
  }

  function buildRecentData() {
    showLoading();
    startLogMonitoring(); // é–‹å§‹ç›£æ§ log

    fetch('/data-builder/build/recent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ days_back: 7 })
    })
      .then(response => response.json())
      .then(data => {
        showResult('âš¡ æœ€è¿‘æ•¸æ“šå»ºç½®å®Œæˆ', 'æˆåŠŸå»ºç½® ' + (data.summary?.total_records || 0) + ' ç­†è¨˜éŒ„');
      })
      .catch(error => {
        showResult('âŒ éŒ¯èª¤', 'å»ºç½®å¤±æ•—: ' + error.message);
      })
      .finally(() => {
        hideLoading();
        setTimeout(() => stopLogMonitoring(), 5000); // 5ç§’å¾Œåœæ­¢ç›£æ§
      });
  }

  function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result-section').style.display = 'none';
  }

  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
  }

  function showResult(title, content) {
    document.getElementById('result-title').textContent = title;
    document.getElementById('result-content').innerHTML = content;
    document.getElementById('result-section').style.display = 'block';
  }

  function startLogin() {
    fetch('/auth/login')
      .then(response => response.json())
      .then(data => {
        if (data.auth_url) {
          window.location.href = data.auth_url;
        } else {
          alert('ç™»å…¥å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      })
      .catch(error => {
        alert('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
      });
  }

  // Log ç›£æ§ç›¸é—œè®Šæ•¸
  let logMonitoringInterval = null;
  let isLogMonitoring = false;
  let lastLogTimestamp = null;

  function toggleLogMonitoring() {
    if (isLogMonitoring) {
      stopLogMonitoring();
    } else {
      startLogMonitoring();
    }
  }

  function startLogMonitoring() {
    if (isLogMonitoring) return;

    isLogMonitoring = true;
    document.getElementById('log-section').style.display = 'block';
    document.getElementById('log-toggle-btn').textContent = 'ğŸ”´ åœæ­¢ç›£æ§';
    document.getElementById('log-toggle-btn').style.background = '#dc3545';

    // æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡æ–°çš„ log
    logMonitoringInterval = setInterval(fetchRecentLogs, 2000);

    // ç«‹å³åŸ·è¡Œä¸€æ¬¡
    fetchRecentLogs();
  }

  function stopLogMonitoring() {
    if (!isLogMonitoring) return;

    isLogMonitoring = false;
    document.getElementById('log-toggle-btn').textContent = 'ğŸŸ¢ é–‹å§‹ç›£æ§';
    document.getElementById('log-toggle-btn').style.background = '';

    if (logMonitoringInterval) {
      clearInterval(logMonitoringInterval);
      logMonitoringInterval = null;
    }
  }

  function fetchRecentLogs() {
    const params = lastLogTimestamp ? `?since=${lastLogTimestamp}` : '?lines=20';

    fetch(`/api/logs${params}`)
      .then(response => response.json())
      .then(data => {
        if (data.logs && data.logs.length > 0) {
          appendLogs(data.logs);
          lastLogTimestamp = data.latest_timestamp;
        }
      })
      .catch(error => {
        console.error('Failed to fetch logs:', error);
      });
  }

  function appendLogs(logs) {
    const logContent = document.getElementById('log-content');

    logs.forEach(log => {
      const logLine = document.createElement('div');
      logLine.style.marginBottom = '2px';

      // æ ¹æ“š log é¡å‹è¨­å®šé¡è‰²
      if (log.includes('ERROR')) {
        logLine.style.color = '#ff6b6b';
      } else if (log.includes('WARNING')) {
        logLine.style.color = '#feca57';
      } else if (log.includes('data_builder') || log.includes('Building')) {
        logLine.style.color = '#48cae4';
      } else if (log.includes('gsc_client') || log.includes('Syncing')) {
        logLine.style.color = '#06ffa5';
      } else {
        logLine.style.color = '#00ff00';
      }

      logLine.textContent = log;
      logContent.appendChild(logLine);
    });

    // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
    logContent.scrollTop = logContent.scrollHeight;
  }

  function clearLogs() {
    document.getElementById('log-content').innerHTML = '<div style="color: #888;">Log å·²æ¸…é™¤...</div>';
    lastLogTimestamp = null;
  }

  // é€²åº¦è¿½è¹¤ç›¸é—œå‡½æ•¸
  function showProgressPanel() {
    document.getElementById('progress-panel').style.display = 'block';
    loadRunningTasks();
    loadRecentTasks();
  }

  function hideProgressPanel() {
    document.getElementById('progress-panel').style.display = 'none';
  }

  function loadRunningTasks() {
    fetch('/data-builder/progress/running')
      .then(response => response.json())
      .then(data => {
        const content = document.getElementById('running-tasks-content');

        if (data.running_tasks && data.running_tasks.length > 0) {
          let html = '';
          data.running_tasks.forEach(task => {
            const progress = task.progress_percentage || 0;
            const statusColor = task.status === 'running' ? '#28a745' : '#dc3545';

            html += `
              <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${task.site_name || 'Unknown Site'}</strong> 
                    <span style="color: ${statusColor};">(${task.status})</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 12px; color: #666;">
                      ${task.current_date || 'N/A'} | ${task.completed_dates || 0}/${task.total_dates || 0} å¤©
                    </div>
                    <button onclick="cancelTask('${task.task_id}')" 
                            style="background: #dc3545; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;"
                            title="å–æ¶ˆæ­¤ä»»å‹™">ğŸ›‘</button>
                  </div>
                </div>
                <div style="margin: 5px 0;">
                  <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: #007bff; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                  </div>
                  <div style="font-size: 12px; color: #666; margin-top: 2px;">
                    ${progress.toFixed(1)}% å®Œæˆ | ${task.total_records || 0} ç­†è¨˜éŒ„
                  </div>
                </div>
                <div style="font-size: 11px; color: #999;">
                  ä»»å‹™ ID: ${task.task_id} | é¡å‹: ${task.task_type}
                </div>
              </div>
            `;
          });
          content.innerHTML = html;
        } else {
          content.innerHTML = '<div style="color: #666; font-style: italic;">ç›®å‰æ²’æœ‰é‹è¡Œä¸­çš„ä»»å‹™</div>';
        }
      })
      .catch(error => {
        document.getElementById('running-tasks-content').innerHTML =
          '<div style="color: #dc3545;">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
      });
  }

  function loadRecentTasks() {
    fetch('/data-builder/progress/recent?limit=5')
      .then(response => response.json())
      .then(data => {
        const content = document.getElementById('recent-tasks-content');

        if (data.recent_tasks && data.recent_tasks.length > 0) {
          let html = '';
          data.recent_tasks.forEach(task => {
            const statusColor = task.status === 'completed' ? '#28a745' :
              task.status === 'failed' ? '#dc3545' : '#ffc107';
            const statusIcon = task.status === 'completed' ? 'âœ…' :
              task.status === 'failed' ? 'âŒ' : 'â³';

            html += `
              <div style="border: 1px solid #ddd; padding: 8px; margin: 3px 0; border-radius: 5px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span>${statusIcon}</span>
                    <strong>${task.site_name || 'Unknown Site'}</strong>
                    <span style="color: ${statusColor};">(${task.status})</span>
                  </div>
                  <div style="font-size: 11px; color: #666;">
                    ${task.completed_at || task.updated_at || 'N/A'}
                  </div>
                </div>
                <div style="font-size: 12px; color: #666;">
                  ${task.completed_dates || 0}/${task.total_dates || 0} å¤© | 
                  ${task.total_records || 0} ç­†è¨˜éŒ„
                  ${task.error_message ? ' | éŒ¯èª¤: ' + task.error_message : ''}
                </div>
              </div>
            `;
          });
          content.innerHTML = html;
        } else {
          content.innerHTML = '<div style="color: #666; font-style: italic;">æ²’æœ‰æœ€è¿‘çš„ä»»å‹™è¨˜éŒ„</div>';
        }
      })
      .catch(error => {
        document.getElementById('recent-tasks-content').innerHTML =
          '<div style="color: #dc3545;">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
      });
  }

  function resumeInterruptedTasks() {
    if (!confirm('ç¢ºå®šè¦æ¢å¾©ä¸­æ–·çš„ä»»å‹™å—ï¼Ÿé€™å°‡æ¨™è¨˜ä¸­æ–·çš„ä»»å‹™ä¸¦å¯èƒ½å‰µå»ºæ–°çš„æ¢å¾©ä»»å‹™ã€‚')) {
      return;
    }

    fetch('/data-builder/progress/resume', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
      .then(response => response.json())
      .then(data => {
        showResult('ğŸ”„ ä»»å‹™æ¢å¾©', data.message);
        if (document.getElementById('progress-panel').style.display !== 'none') {
          loadRunningTasks();
          loadRecentTasks();
        }
      })
      .catch(error => {
        showResult('âŒ éŒ¯èª¤', 'æ¢å¾©ä»»å‹™å¤±æ•—: ' + error.message);
      });
  }

  function cancelTask(taskId) {
    if (!confirm(`ç¢ºå®šè¦å–æ¶ˆä»»å‹™ ${taskId} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`)) {
      return;
    }

    fetch(`/data-builder/progress/cancel/${taskId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: 'User cancelled via web interface' })
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showResult('âŒ éŒ¯èª¤', data.error);
        } else {
          showResult('ğŸ›‘ ä»»å‹™å·²å–æ¶ˆ', data.message);
          // åˆ·æ–°é€²åº¦é¡¯ç¤º
          if (document.getElementById('progress-panel').style.display !== 'none') {
            loadRunningTasks();
            loadRecentTasks();
          }
        }
      })
      .catch(error => {
        showResult('âŒ éŒ¯èª¤', 'å–æ¶ˆä»»å‹™å¤±æ•—: ' + error.message);
      });
  }

  function cancelAllTasks() {
    if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ‰€æœ‰é‹è¡Œä¸­çš„ä»»å‹™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
      return;
    }

    fetch('/data-builder/progress/cancel-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: 'User cancelled all tasks via web interface' })
    })
      .then(response => response.json())
      .then(data => {
        showResult('ğŸ›‘ æ‰¹é‡å–æ¶ˆå®Œæˆ', data.message);
        // åˆ·æ–°é€²åº¦é¡¯ç¤º
        if (document.getElementById('progress-panel').style.display !== 'none') {
          loadRunningTasks();
          loadRecentTasks();
        }
      })
      .catch(error => {
        showResult('âŒ éŒ¯èª¤', 'æ‰¹é‡å–æ¶ˆå¤±æ•—: ' + error.message);
      });
  }

  // å–®ç«™é»å»ºç½®ç›¸é—œå‡½æ•¸
  function showSiteBuildPanel() {
    document.getElementById('site-build-panel').style.display = 'block';
    loadSiteOptions();
    setDefaultDates();
  }

  function hideSiteBuildPanel() {
    document.getElementById('site-build-panel').style.display = 'none';
    document.getElementById('site-build-status').style.display = 'none';
  }

  function loadSiteOptions() {
    // å¾ç¾æœ‰çš„ç«™é»æ•¸æ“šè¼‰å…¥é¸é …
    const siteSelect = document.getElementById('site-select');
    siteSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç«™é»...</option>';

    // å¾ç«™é»è¡¨æ ¼ä¸­ç²å–ç«™é»è³‡è¨Š
    const siteRows = document.querySelectorAll('.sites-table tbody tr');
    siteRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length >= 4) {
        const siteName = cells[0].textContent.trim();
        const keywordCount = cells[1].textContent.trim();

        // å¾æ“ä½œåˆ—çš„é€£çµä¸­æå– site_id
        const actionLink = cells[4].querySelector('a[href*="missing-dates"]');
        if (actionLink) {
          const href = actionLink.getAttribute('href');
          const siteIdMatch = href.match(/missing-dates\/(\d+)/);
          if (siteIdMatch) {
            const siteId = siteIdMatch[1];
            const option = document.createElement('option');
            option.value = siteId;
            option.textContent = `${siteName} (${keywordCount} é—œéµå­—)`;
            siteSelect.appendChild(option);
          }
        }
      }
    });
  }

  function setDefaultDates() {
    const today = new Date();
    const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    const threeDaysAgo = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000); // GSC æ•¸æ“šå»¶é²

    document.getElementById('start-date').value = oneWeekAgo.toISOString().split('T')[0];
    document.getElementById('end-date').value = threeDaysAgo.toISOString().split('T')[0];
  }

  function startSiteBuild() {
    const siteId = document.getElementById('site-select').value;
    const buildMode = document.getElementById('build-mode').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!siteId) {
      alert('è«‹é¸æ“‡ä¸€å€‹ç«™é»');
      return;
    }

    let buildData = {};
    let endpoint = '';

    if (buildMode === 'recent') {
      // æœ€è¿‘æ•¸æ“šå»ºç½®
      endpoint = '/data-builder/build/recent';
      buildData = {
        site_ids: [parseInt(siteId)],
        days_back: 7
      };
    } else {
      // æ—¥æœŸç¯„åœå»ºç½®
      if (!startDate || !endDate) {
        alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
        return;
      }

      endpoint = `/data-builder/build/site/${siteId}`;
      buildData = {
        start_date: startDate,
        end_date: endDate,
        force_rebuild: buildMode === 'force'
      };
    }

    // é¡¯ç¤ºå»ºç½®ç‹€æ…‹
    document.getElementById('site-build-status').style.display = 'block';
    document.getElementById('site-build-progress').innerHTML = `
      <div style="color: #155724;">
        <div>ğŸš€ æ­£åœ¨å•Ÿå‹•å»ºç½®...</div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          ç«™é»: ${document.getElementById('site-select').selectedOptions[0].text}<br>
          æ¨¡å¼: ${buildMode === 'incremental' ? 'å¢é‡å»ºç½®' : buildMode === 'force' ? 'å¼·åˆ¶é‡å»º' : 'æœ€è¿‘æ•¸æ“š'}<br>
          ${buildMode !== 'recent' ? `æ—¥æœŸç¯„åœ: ${startDate} åˆ° ${endDate}` : 'æ—¥æœŸç¯„åœ: æœ€è¿‘7å¤©'}
        </div>
      </div>
    `;

    // é–‹å§‹å³æ™‚ log ç›£æ§
    startLogMonitoring();

    // ç™¼é€å»ºç½®è«‹æ±‚
    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(buildData)
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          document.getElementById('site-build-progress').innerHTML = `
            <div style="color: #dc3545;">
              âŒ å»ºç½®å¤±æ•—: ${data.error}
            </div>
          `;
        } else {
          const taskId = data.task_id;
          document.getElementById('site-build-progress').innerHTML = `
            <div style="color: #28a745;">
              âœ… å»ºç½®å·²å®Œæˆï¼<br>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ${data.message}<br>
                ${data.summary ? `ç¸½è¨˜éŒ„æ•¸: ${data.summary.total_records || 0}` : ''}
                ${taskId ? `<br>ä»»å‹™ ID: ${taskId}` : ''}
              </div>
            </div>
          `;

          // åˆ·æ–°ç‹€æ…‹
          loadBuildStatus();
          if (document.getElementById('progress-panel').style.display !== 'none') {
            loadRunningTasks();
            loadRecentTasks();
          }
        }
      })
      .catch(error => {
        document.getElementById('site-build-progress').innerHTML = `
          <div style="color: #dc3545;">
            âŒ å»ºç½®å¤±æ•—: ${error.message}
          </div>
        `;
      })
      .finally(() => {
        setTimeout(() => stopLogMonitoring(), 3000); // 3ç§’å¾Œåœæ­¢ç›£æ§
      });
  }

  // é é¢è¼‰å…¥å¾Œè‡ªå‹•è¼‰å…¥ç‹€æ…‹
  document.addEventListener('DOMContentLoaded', function () {
    // åªæœ‰åœ¨å·²ç™»å…¥ç‹€æ…‹æ‰è¼‰å…¥
    if (document.querySelector('.status.success')) {
      loadBuildStatus();
    }
  });
</script>
{% endblock %}